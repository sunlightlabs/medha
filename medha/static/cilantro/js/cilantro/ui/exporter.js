define(["jquery","underscore","backbone","marionette","./base","./core"],function(e,t,a,i,s,n){var o=i.ItemView.extend({tagName:"label",className:"checkbox",template:"export/option"}),l=s.EmptyView.extend({message:"No exporters available."}),r=i.CollectionView.extend({itemView:o,emptyView:l}),c=i.ItemView.extend({template:"export/progress",ui:{status:"[data-target=status]",cancel:"[data-target=cancel]"},events:{"click @ui.cancel":"cancel"},modelEvents:{"change:status":"renderStatus"},getCookieName:function(){return"export-type-"+this.model.get("type")},getExportUrl:function(){var e=this.model.get("uri");return"/"!==e.charAt(e.length-1)&&(e+="/"),e+(this.model.get("pages")||"")},initialize:function(){var t=this.getCookieName(),a=this.getExportUrl();this.iframe=e("<iframe />").attr("src",a).css("display","none"),this.model.set({url:a,cookie:t,status:"pending",time:0})},start:function(e){if("canceled"!==this.model.get("status")){n.utils.setCookie(this.model.get("cookie"),null),this.$el.append(this.iframe);var t=this,a=setInterval(function(){t.check()},e.monitorDelay);this.model.set({interval:a,status:"loading"})}},cancel:function(){var t=this.model.get("cookie"),a=this.model.get("interval");clearInterval(a),n.utils.setCookie(t,null),this.iframe.remove(),this.model.set("status","canceled"),e.ajax({type:"DELETE",url:this.getExportUrl(),contentType:"application/json"})},check:function(){var e=this.model.get("cookie"),t=this.model.get("time"),a=this.model.get("interval");t+=this.monitorDelay,"complete"===n.utils.getCookie(e)?(clearInterval(a),n.utils.setCookie(e,null),this.model.set("status","complete")):t>=this.options.monitorTimeout?(clearInterval(a),this.model.set("status","timeout")):this.checkError()&&(clearInterval(a),this.model.set("status","error"))},checkError:function(){return this.iframe[0].document?0!==this.iframe.contents()[0].body.children.length:!1},renderStatus:function(e,t){var a,i=!0;switch(t){case"error":a='<span class="label label-important">Error</span>';break;case"timeout":a='<span class="label label-warning">Request Timed Out</span>';break;case"complete":a='<span class="label label-success">Complete</span>';break;case"loading":a='<div class="label label-info"><i class="icon-spinner icon-spin"></i> Downloading...</span>',i=!1;break;case"canceled":a='<span class="label label-warning">Canceled</span>'}this.ui.status.html(a),this.model.set("done",i)}}),p=i.CompositeView.extend({className:"export-batch",template:"export/batch",itemView:c,start:function(){var e=this.options;this.children.each(function(a,i){t.delay(function(){a.start(e)},i*e.requestDelay)})},finish:function(){var e=this;this.$el.html('<h3><i class="icon-ok-sign text-success" /> Export Done</h3>').css("text-align","center"),t.delay(function(){e.$el.slideUp({duration:300,easing:"easeInOutQuad",complete:function(){e.close()}})},2e3)}}),h=/^[0-9]+(\.\.\.[0-9]+)?$/,u=i.Layout.extend({template:"export/dialog",id:"exporter-dialog",className:"modal hide",options:{requestDelay:500,monitorDelay:200,monitorTimeout:6e5},ui:{pageOption:"[name=pages]",pageRange:"[name=page-range]",error:"[data-target=error]",save:"[data-toggle=save]"},events:{"click @ui.save":"exportData","click @ui.pageOption":"togglePageOption","click [data-action=change-columns]":"changeColumnsClicked"},regions:{types:"[data-target=types]",progress:"[data-target=progress]"},initialize:function(){if(this.data={},!(this.data.exporters=this.options.exporters))throw new Error("exporters collection required")},open:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")},onRender:function(){this.$el.modal({show:!1});var e=new r({collection:this.data.exporters});this.types.show(e)},togglePageOption:function(){this.ui.pageRange.prop("disabled",!this.pageRangeSelected())},getSelectedOptions:function(){return this.types.currentView.$(":checked").map(function(){return this.value})},getPageRange:function(){return this.pageRangeSelected()?this.ui.pageRange.val():void 0},pageRangeSelected:function(){return"range"===this.ui.pageOption.filter(":checked").val()},isPageRangeValid:function(){return h.test(this.getPageRange())},changeColumnsClicked:function(){n.dialogs.columns.open()},validate:function(){var e=[],t=this.getSelectedOptions();return this.pageRangeSelected()&&!this.isPageRangeValid()&&e.push("<p>The page range entered is invalid. It must be a single page, e.g. 1, or a range of pages, e.g. 2...5.</p>"),0===t.length&&e.push("<p>An export type must be selected.</p>"),0===n.data.views.session.facets.length&&e.push("<p>One or more columns must be selected. Click <a data-action=change-columns>here</a> to select columns.</p>"),e},exportData:function(){this.ui.error.hide();var e=this.getSelectedOptions(),i=this.validate();if(i.length)return void this.ui.error.html(i).show();this.ui.save.prop("disabled",!0);var s,n=this,o=t.map(e,function(e){return s=n.data.exporters.get(e).toJSON(),s.pages=n.getPageRange(),s}),l=new a.Collection(o);this.listenTo(l,"change:status",function(){l.where({done:!0}).length===l.length&&(this.stopListening(l),this.ui.save.prop("disabled",!1),t.delay(function(){r.finish()},1e3))});var r=new p(t.extend({collection:l},this.options));this.progress.show(r),r.start()}});return{ExporterDialog:u}});
//# sourceMappingURL=exporter.js
//# sourceMappingURL=exporter.js.map